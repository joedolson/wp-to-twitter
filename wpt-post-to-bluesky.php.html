<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: wpt-post-to-bluesky.php - XPoster Hook Doumentation</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
    <link type="text/css" rel="stylesheet" href="styles-docs.css?v=0.1.1">
</head>

<body>

<div id="main">

    <header><h1 class="page-title">Source: wpt-post-to-bluesky.php</h1></header>
	<main>
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>&lt;?php
/**
 * Send API queries for a post to Bluesky.
 *
 * @category Post from WordPress.
 * @package  XPoster
 * @author   Joe Dolson
 * @license  GPLv2 or later
 * @link     https://www.xposter.com
 */

if ( ! defined( 'ABSPATH' ) ) {
	exit;
} // Exit if accessed directly.

require_once plugin_dir_path( __FILE__ ) . 'classes/class-wpt-bluesky-api.php';

/**
 * Upload media to Bluesky API.
 *
 * @param object   $connection Bluesky connection.
 * @param int|bool $auth Connection context.
 * @param int      $attachment Attachment ID.
 * @param array    $status Array of posting information.
 * @param int      $id Post ID.
 * @param string   $request_type Whether an upload or card should be added to Bluesky request.
 *
 * @return array Image blob array to be posted with status.
 */
function wpt_upload_bluesky_media( $connection, $auth, $attachment, $status, $id, $request_type = 'upload' ) {
	$request = array();
	if ( $connection ) {
		$card = ( function_exists( 'wpt_card_data' ) ) ? wpt_card_data( $id, 'og' ) : false;
		if ( ! $card ) {
			// If there's no card data, return early.
			return $request;
		}
		if ( $attachment ) {
			$allowed = wpt_check_mime_type( $attachment, 'bluesky' );
			if ( ! $allowed ) {
				wpt_mail( 'Media upload mime type not accepted by Bluesky', get_post_mime_type( $attachment ), $id );

				return $request;
			}
			$alt_text = get_post_meta( $attachment, '_wp_attachment_image_alt', true );
			/**
			 * Add alt attributes to uploaded images.
			 *
			 * @hook wpt_uploaded_image_alt
			 *
			 * @param {string} $alt_text Text stored in media library as alt.
			 * @param {int}    $attachment Attachment ID.
			 *
			 * @return {string}
			 */
			$alt_text  = apply_filters( 'wpt_uploaded_image_alt', $alt_text, $attachment );
			$path      = wpt_attachment_path( $attachment, 'large' );
			$mimetype  = mime_content_type( $path );
			$mimetypes = array( 'image/png', 'image/jpeg', 'image/webp' );
			$size      = filesize( $path );
			// Return without attempting if fails to fetch image object.
			if ( ! ( in_array( $mimetype, $mimetypes, true ) &amp;&amp; (int) $size &lt; 1000000 ) ) {
				return $request;
			}
			$attachment_data = wpt_image_binary( $attachment, 'bluesky' );
			if ( ! $attachment_data ) {
				return $request;
			}
			$request = array(
				'data'         => $attachment_data,
				'content-type' => $mimetype,
			);
			$blob    = $connection->call_api( 'https://bsky.social/xrpc/com.atproto.repo.uploadBlob', $request );
			if ( 'upload' === $request_type ) {
				$request = array(
					'$type'  => 'app.bsky.embed.images',
					'images' => array(
						array(
							'alt'   => $alt_text,
							'image' => $blob['blob'],
						),
					),
				);
			} else {
				$card    = wpt_card_data( $id, 'og' );
				$request = array(
					'$type'    => 'app.bsky.embed.external',
					'external' => array(
						'uri'         => get_the_permalink( $id ),
						'title'       => $card['title'],
						'description' => $card['description'],
						'thumb'       => $blob['blob'],
					),
				);
			}
			wpt_mail( 'Media Uploaded (Bluesky)', "$auth, $attachment" . PHP_EOL . print_r( $blob, 1 ), $id );
		}
		if ( ! $attachment &amp;&amp; 'card' === $request_type ) {
			$request = array(
				'$type'    => 'app.bsky.embed.external',
				'external' => array(
					'uri'         => get_the_permalink( $id ),
					'title'       => $card['title'],
					'description' => $card['description'],
				),
			);
			wpt_mail( 'Bluesky Card without media', "$auth, $attachment" . PHP_EOL . print_r( $blob, 1 ), $id );

		}
	}

	return $request;
}

/**
 * Post status to Bluesky.
 *
 * @param object $connection Connection to Bluesky.
 * @param mixed  $auth Main site or specific author ID.
 * @param int    $id Post ID.
 * @param array  $status Array of information sent to Bluesky.
 * @param array  $image Array of image data to add to Bluesky post.
 *
 * @return array
 */
function wpt_send_post_to_bluesky( $connection, $auth, $id, $status, $image ) {
	$notice = '';
	/**
	 * Turn on staging mode. Staging mode is automatically turned on if WPT_STAGING_MODE constant is defined.
	 *
	 * @hook wpt_staging_mode
	 * @param {bool}     $staging_mode True to enable staging mode.
	 * @param {int|bool} $auth Current author.
	 * @param {int}      $id Post ID.
	 * @param {string}   $service Service being put into staging.
	 *
	 * @return {bool}
	 */
	$staging_mode = apply_filters( 'wpt_staging_mode', false, $auth, $id, 'bluesky' );
	if ( ( defined( 'WPT_STAGING_MODE' ) &amp;&amp; true === WPT_STAGING_MODE ) || $staging_mode ) {
		// if in staging mode, we'll behave as if the update succeeded, but not send it.
		$connection = true;
		$success    = true;
		$http_code  = 200;
		$notice     = __( 'In Staging Mode:', 'wp-to-twitter' ) . ' ' . $status['text'];
		$status_id  = false;
	} else {
		/**
		 * Filter the approval to send a Bluesky Skeet.
		 *
		 * @hook wpt_do_skeet
		 * @param {bool}     $do_skeet Return false to cancel this Skeet.
		 * @param {int|bool} $auth Author.
		 * @param {int}      $id Post ID.
		 * @param {string}   $text Status update text.
		 *
		 * @return {bool}
		 */
		$do_post   = apply_filters( 'wpt_do_skeet', true, $auth, $id, $status['text'] );
		$status_id = false;
		$success   = false;
		// Change status array to Bluesky expectation.
		$status = array(
			'type'      => 'app.bsky.feed.post',
			'text'      => $status['text'],
			'createdAt' => gmdate( DATE_ATOM ),
		);
		if ( ! empty( $image ) ) {
			$status['embed'] = $image;
		}
		/**
		 * Filter status array for Bluesky.
		 *
		 * @hook wpt_filter_bluesky_status
		 *
		 * @param {array}    $status Array of parameters sent to Bluesky.
		 * @param {int}      $post Post ID being tweeted.
		 * @param {int|bool} $auth Authoring context.
		 *
		 * @return {array}
		 */
		$status = apply_filters( 'wpt_filter_bluesky_status', $status, $id, $auth );
		if ( $do_post ) {
			$return = $connection->post_status( $status );
			if ( isset( $return['cid'] ) ) {
				$success   = true;
				$http_code = 200;
				$status_id = $return['cid'];
				$notice   .= __( 'Sent to Bluesky.', 'wp-to-twitter' );
			} else {
				$http_code = 401;
				$notice   .= __( 'Bluesky status update failed.', 'wp-to-twitter' );
			}
		} else {
			$http_code = '000';
			$notice   .= __( 'Bluesky status update cancelled by custom filter.', 'wp-to-twitter' );
		}
	}

	return array(
		'return'    => $success,
		'http'      => $http_code,
		'notice'    => $notice,
		'status_id' => $status_id,
		'service'   => 'bluesky',
	);
}

/**
 * Establish a client to Bluesky.
 *
 * @param mixed int|boolean $auth Current author context.
 * @param array             $verify Array of credentials to validate.
 *
 * @return mixed array or false
 */
function wpt_bluesky_connection( $auth = false, $verify = false ) {
	if ( ! empty( $verify ) ) {
		$password = $verify['password'];
		$user     = $verify['identifier'];
	} else {
		if ( ! $auth ) {
			$password = get_option( 'wpt_bluesky_token' );
			$user     = get_option( 'wpt_bluesky_username' );
		} else {
			$password = get_user_meta( $auth, 'wpt_bluesky_token', true );
			$user     = get_user_meta( $auth, 'wpt_bluesky_username', true );
		}
	}
	$bluesky = false;
	if ( $password &amp;&amp; $user ) {
		$bluesky = new Wpt_Bluesky_Api( $user, $password );
		if ( $verify ) {
			$verify = $bluesky->verify();

			return $verify;
		}
	}

	return $bluesky;
}
</code></pre>
        </article>
    </section>




	</main>
    <footer>
		<a href="https://docs.joedolson.com/">XPoster User Documentation</a> &bull;
		<a href="https://github.com/joedolson/wp-to-twiter/">XPoster on GitHub</a> &bull;
		<a href="https://www.xposterpro.com/">Buy XPoster Pro</a>
	</footer>

	
</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Actions</h3><ul><li><a href="wpt_insert_post.html">wpt_insert_post</a></li><li><a href="wpt_post_to_service.html">wpt_post_to_service</a></li><li><a href="wpt_tweet_failed.html">wpt_tweet_failed</a></li><li><a href="wpt_tweet_posted.html">wpt_tweet_posted</a></li></ul><h3>Filters</h3><ul><li><a href="wpt_allow_copy_meta.html">wpt_allow_copy_meta</a></li><li><a href="wpt_allowed_post_types.html">wpt_allowed_post_types</a></li><li><a href="wpt_auto_tweet_allowed.html">wpt_auto_tweet_allowed</a></li><li><a href="wpt_custom_shortcode.html">wpt_custom_shortcode</a></li><li><a href="wpt_custom_tag.html">wpt_custom_tag</a></li><li><a href="wpt_custom_truncate.html">wpt_custom_truncate</a></li><li><a href="wpt_do_shortening.html">wpt_do_shortening</a></li><li><a href="wpt_do_skeet.html">wpt_do_skeet</a></li><li><a href="wpt_do_toot.html">wpt_do_toot</a></li><li><a href="wpt_do_tweet.html">wpt_do_tweet</a></li><li><a href="wpt_edit_sensitivity.html">wpt_edit_sensitivity</a></li><li><a href="wpt_exclude_post_types.html">wpt_exclude_post_types</a></li><li><a href="wpt_filter_bluesky_status.html">wpt_filter_bluesky_status</a></li><li><a href="wpt_filter_mastodon_status.html">wpt_filter_mastodon_status</a></li><li><a href="wpt_filter_post_data.html">wpt_filter_post_data</a></li><li><a href="wpt_filter_truncated_value.html">wpt_filter_truncated_value</a></li><li><a href="wpt_hash_source.html">wpt_hash_source</a></li><li><a href="wpt_max_length.html">wpt_max_length</a></li><li><a href="wpt_post_attachment.html">wpt_post_attachment</a></li><li><a href="wpt_recent_tweet_threshold.html">wpt_recent_tweet_threshold</a></li><li><a href="wpt_service_enabled.html">wpt_service_enabled</a></li><li><a href="wpt_settings_tabs_pages.html">wpt_settings_tabs_pages</a></li><li><a href="wpt_shorten_link.html">wpt_shorten_link</a></li><li><a href="wpt_should_block_status.html">wpt_should_block_status</a></li><li><a href="wpt_show_last_update.html">wpt_show_last_update</a></li><li><a href="wpt_staging_mode.html">wpt_staging_mode</a></li><li><a href="wpt_tag_default.html">wpt_tag_default</a></li><li><a href="wpt_tags.html">wpt_tags</a></li><li><a href="wpt_tweet_sentence.html">wpt_tweet_sentence</a></li><li><a href="wpt_twitter_category_descs.html">wpt_twitter_category_descs</a></li><li><a href="wpt_twitter_category_names.html">wpt_twitter_category_names</a></li><li><a href="wpt_upload_image_size.html">wpt_upload_image_size</a></li><li><a href="wpt_upload_media.html">wpt_upload_media</a></li><li><a href="wpt_uploaded_image_alt.html">wpt_uploaded_image_alt</a></li><li><a href="wpt_use_featured_image.html">wpt_use_featured_image</a></li><li><a href="wpt_user_meta_shortcode.html">wpt_user_meta_shortcode</a></li><li><a href="wpt_utm_medium.html">wpt_utm_medium</a></li><li><a href="wpt_utm_source.html">wpt_utm_source</a></li><li><a href="wptt_shorten_link.html">wptt_shorten_link</a></li></ul>
</nav>

<br class="clear">

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
